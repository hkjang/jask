// Prisma Schema for Jask - NL2SQL Service
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ===========================================
// Enums
// ===========================================
enum ImportanceLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SensitivityLevel {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  STRICT
}

enum RelationType {
  FK      // 물리적 Foreign Key
  LOGICAL // 논리적 관계
}

enum PolicyType {
  QUERY
  SQL
  METADATA
  MODEL
  DOMAIN
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum VerificationStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

// 데이터소스 접근 역할
enum DataSourceRole {
  VIEWER  // 조회만 가능
  EDITOR  // 조회 + 쿼리 실행
  ADMIN   // 조회 + 쿼리 실행 + 메타데이터 수정 + 권한 관리
}

// ===========================================
// 데이터 소스 연결 정보
// ===========================================
model DataSource {
  id          String   @id @default(uuid())
  name        String
  type        String   // postgresql, mysql, oracle, mssql
  host        String
  port        Int
  database    String
  username    String
  password    String   @db.Text // 암호화 저장
  schema      String?  @default("public")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 추가 메타데이터
  description   String?  @db.Text
  environment   String   @default("development") // production, staging, development
  
  // SSL 설정
  sslEnabled    Boolean  @default(false)
  sslConfig     Json?    // { mode: 'require'|'verify-ca'|'verify-full', ca?, cert?, key? }
  
  // 연결 풀 설정
  poolConfig    Json?    // { maxConnections, connectionTimeout, idleTimeout }
  
  // 헬스 모니터링
  lastHealthCheck DateTime?
  healthStatus    String   @default("unknown") // healthy, unhealthy, unknown
  
  // 통계
  queryCount      Int      @default(0)
  avgResponseTime Float    @default(0)
  lastActiveAt    DateTime?

  tables      TableMetadata[]
  queries     QueryHistory[]
  samples     SampleQuery[]
  recommendedQuestions RecommendedQuestion[]
  
  // Role-based Access Control
  accessPermissions DataSourceAccess[]
}

// ===========================================
// 테이블 메타데이터
// ===========================================
model TableMetadata {
  id           String   @id @default(uuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  schemaName   String
  tableName    String
  description  String?  @db.Text
  rowCount     Int?
  isExcluded   Boolean  @default(false)
  
  // Extended Metadata
  tags            String[]        @default([])
  importanceLevel ImportanceLevel @default(MEDIUM)
  isSyncedWithAI  Boolean         @default(false)
  
  // Quality & Workflow
  completenessScore Float          @default(0)
  metadataStatus    MetadataStatus @default(DRAFT)
  reviewNotes       String?        @db.Text
  lastAiUpdate      DateTime?

  // View Metadata (Oracle, MySQL, PostgreSQL views)
  tableType         String         @default("TABLE")  // TABLE, VIEW, MATERIALIZED_VIEW
  viewDefinition    String?        @db.Text           // 뷰 SQL 정의

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  columns       ColumnMetadata[]
  relationshipsFrom TableRelationship[] @relation("SourceTable")
  relationshipsTo   TableRelationship[] @relation("TargetTable")

  embedding     SchemaEmbedding?

  @@unique([dataSourceId, schemaName, tableName])
  @@index([dataSourceId])
}

enum MetadataStatus {
  DRAFT
  PENDING_REVIEW
  VERIFIED
}

// ===========================================
// 컬럼 메타데이터
// ===========================================
model ColumnMetadata {
  id               String   @id @default(uuid())
  tableId          String
  table            TableMetadata @relation(fields: [tableId], references: [id], onDelete: Cascade)

  columnName       String
  dataType         String
  description      String?  @db.Text
  
  // Extended Metadata
  semanticName     String?  // 비즈니스/논리적 이름
  unit             String?  // 단위 (예: kg, cm, krw)
  isCode           Boolean  @default(false)
  sensitivityLevel SensitivityLevel @default(INTERNAL)

  isPrimaryKey     Boolean  @default(false)
  isForeignKey     Boolean  @default(false)
  referencedTable  String?
  referencedColumn String?
  isNullable       Boolean  @default(true)
  isExcluded       Boolean  @default(false)  // AI 컨텍스트에서 제외
  codeValues       Json?    // Deprecated: Use CodeValue model instead if managing complex codes
  
  codeValueList    CodeValue[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([tableId, columnName])
  @@index([tableId])
}

// ===========================================
// 코드값 관리
// ===========================================
model CodeValue {
  id           String   @id @default(uuid())
  columnId     String
  column       ColumnMetadata @relation(fields: [columnId], references: [id], onDelete: Cascade)

  code         String
  value        String
  description  String?
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([columnId, code])
  @@index([columnId])
}

// ===========================================
// 테이블 관계 (물리적 + 논리적)
// ===========================================
model TableRelationship {
  id            String       @id @default(uuid())
  
  sourceTableId String
  sourceTable   TableMetadata @relation("SourceTable", fields: [sourceTableId], references: [id], onDelete: Cascade)
  
  targetTableId String
  targetTable   TableMetadata @relation("TargetTable", fields: [targetTableId], references: [id], onDelete: Cascade)
  
  relationType  RelationType @default(LOGICAL)
  description   String?      @db.Text
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([sourceTableId])
  @@index([targetTableId])
}

// ===========================================
// 쿼리 히스토리
// ===========================================
model QueryHistory {
  id           String   @id @default(uuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  userId       String
  user         User     @relation(fields: [userId], references: [id])

  naturalQuery String   @db.Text  // 자연어 질문
  generatedSql String   @db.Text  // 생성된 SQL
  finalSql     String?  @db.Text  // 수정된 SQL
  sqlExplanation String? @db.Text // SQL 설명

  status       QueryStatus @default(PENDING)
  executionTime Int?       // ms
  rowCount     Int?
  errorMessage String?    @db.Text

  feedback     Feedback?
  feedbackNote String?    @db.Text

  // Extended Features
  trustScore        Float?             // 0.0 to 1.0
  riskLevel         RiskLevel          @default(LOW)
  verificationStatus VerificationStatus @default(NONE)

  comments          QueryComment[]
  shares            QueryShare[]

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([dataSourceId])
  @@index([createdAt])

  actions           UserActionLog[]
  
  // Relation to Thread Messages
  messages          Message[]
}

enum QueryStatus {
  PENDING
  VALIDATING
  EXECUTING
  SUCCESS
  FAILED
  BLOCKED
}

enum Feedback {
  POSITIVE
  NEGATIVE
}

// ===========================================
// 샘플 쿼리 (정확도 향상용 RAG)
// ===========================================
model SampleQuery {
  id           String   @id @default(uuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  naturalQuery String   @db.Text
  sqlQuery     String   @db.Text
  description  String?  @db.Text
  tags         String[] @default([])
  isVerified   Boolean  @default(false)
  embedding    Unsupported("vector")?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([dataSourceId])
}

// ===========================================
// 사용자
// ===========================================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  role         Role     @default(USER)
  isActive     Boolean  @default(true)

  queries      QueryHistory[]
  favorites    FavoriteQuery[]
  favoriteFolders FavoriteFolder[]
  
  // Collaboration
  comments     QueryComment[]
  shares       QueryShare[]     @relation("SharedBy")

  // Threads
  threads      Thread[]
  participations UserThread[]

  // Security Audit
  auditLogs    AuditLog[]

  // Profile
  department   String?
  preferences  Json?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])

  actions      UserActionLog[]
  
  // Role-based Data Source Access
  dataSourceAccess DataSourceAccess[]
}

enum Role {
  USER
  ADMIN
}

// ===========================================
// 데이터소스 접근 권한
// ===========================================
model DataSourceAccess {
  id           String          @id @default(uuid())
  
  userId       String
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dataSourceId String
  dataSource   DataSource      @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  
  role         DataSourceRole  @default(VIEWER)
  
  // 권한 부여 정보
  grantedById  String?         // 권한을 부여한 관리자 ID
  grantedByName String?        // 권한을 부여한 관리자 이름
  grantedAt    DateTime        @default(now())
  expiresAt    DateTime?       // 선택적 만료일
  
  // 메모
  note         String?
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@unique([userId, dataSourceId])
  @@index([userId])
  @@index([dataSourceId])
  @@index([role])
  @@index([expiresAt])
}

// ===========================================
// 즐겨찾기
// ===========================================
model FavoriteQuery {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  naturalQuery String   @db.Text
  sqlQuery     String   @db.Text
  dataSourceId String?
  
  // 폴더 분류
  folderId     String?
  folder       FavoriteFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  
  // 태그 (배열)
  tags         String[] @default([])
  
  // 사용 통계
  useCount     Int      @default(0)
  lastUsedAt   DateTime?
  
  // 정렬
  displayOrder Int      @default(0)
  
  // 메모
  description  String?  @db.Text

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([folderId])
  @@index([useCount])
}

// ===========================================
// 즐겨찾기 폴더
// ===========================================
model FavoriteFolder {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  color        String?  // HEX 컬러 코드
  icon         String?  // Lucide 아이콘 이름
  displayOrder Int      @default(0)
  
  favorites    FavoriteQuery[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

// ===========================================
// 시스템 설정
// ===========================================
model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
}

// ===========================================
// LLM 프로바이더 설정
// ===========================================
model LLMProvider {
  id          String   @id @default(uuid())
  name        String   @unique  // ollama, vllm, openai
  baseUrl     String
  model       String
  apiKey      String?  @db.Text
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  config      Json?    // temperature, max_tokens 등

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===========================================
// 프롬프트 템플릿
// ===========================================
model PromptTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  type        PromptType
  content     String   @db.Text
  variables   String[] @default([])
  isActive    Boolean  @default(true)
  version     Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PromptType {
  NL2SQL
  SQL_EXPLAIN
  SQL_FIX
  RESULT_SUMMARY
}

// ===========================================
// Schema Embeddings (pgvector)
// ===========================================
model SchemaEmbedding {
  id           String   @id @default(uuid())
  
  tableId      String   @unique
  table        TableMetadata @relation(fields: [tableId], references: [id], onDelete: Cascade)
  
  content      String   @db.Text
  embedding    Unsupported("vector")? 
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tableId])
}

// ===========================================
// 거버넌스 정책 (Governance)
// ===========================================
model GovernancePolicy {
  id          String     @id @default(uuid())
  name        String
  type        PolicyType
  description String?
  config      Json       // 정책 설정 (예: { "maxJoins": 3 })
  isActive    Boolean    @default(true)
  priority    Int        @default(0)
  
  createdById String?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// ===========================================
// 협업 - 댓글 (Collaboration)
// ===========================================
model QueryComment {
  id             String       @id @default(uuid())
  queryHistoryId String
  queryHistory   QueryHistory @relation(fields: [queryHistoryId], references: [id], onDelete: Cascade)
  
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content        String       @db.Text
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([queryHistoryId])
}

// ===========================================
// 협업 - 공유 (Collaboration)
// ===========================================
model QueryShare {
  id             String       @id @default(uuid())
  queryHistoryId String
  queryHistory   QueryHistory @relation(fields: [queryHistoryId], references: [id], onDelete: Cascade)
  
  sharedByUserId String
  sharedByUser   User         @relation("SharedBy", fields: [sharedByUserId], references: [id])
  
  sharedToUserId String?      // 특정 사용자에게 공유
  sharedToTeam   String?      // 특정 팀에게 공유
  isPublic       Boolean      @default(false) // 전체 공개
  
  createdAt      DateTime     @default(now())
  
  @@index([queryHistoryId])
  @@index([sharedToUserId])
}

// ===========================================
// AI Evolution - User Actions
// ===========================================
enum ActionType {
  QUERY
  EDIT
  EXECUTE
  RE_ASK
  RATE
  SAVE
  ABANDON
}

model UserActionLog {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  
  queryId      String?
  query        QueryHistory? @relation(fields: [queryId], references: [id])
  
  actionType   ActionType
  payload      Json?      // Store details like editedSQL, rating value
  
  createdAt    DateTime   @default(now())
  
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

// ===========================================
// AI Evolution - Signals & Candidates
// ===========================================
enum CandidateType {
  PROMPT
  METADATA
  MODEL_ROUTING
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
}

model EvolutionSignal {
  id           String   @id @default(uuid())
  targetId     String   // TableId, PromptId, etc.
  signalType   String   // TRUST_SCORE, ERROR_RATE, MISSING_META
  score        Float
  confidence   Float
  dataset      Json?    // Evidence (e.g. list of failed queries)
  updatedAt    DateTime @updatedAt
  
  @@index([targetId])
  @@index([signalType])
}

model EvolutionCandidate {
  id             String         @id @default(uuid())
  type           CandidateType
  targetId       String?        // ID of the item to improve
  
  proposedChange Json           // The new content
  reasoning      String         // Why this change is proposed
  impactAnalysis Json?          // Expected improvement
  
  status         ApprovalStatus @default(PENDING)
  
  createdById    String?        // If manually created
  approverId     String?
  
  createdAt      DateTime       @default(now())
  appliedAt      DateTime?
  
  @@index([status])
  @@index([type])
}

// ===========================================
// 대화 쓰레드 (Conversation Threads)
// ===========================================
model Thread {
  id           String   @id @default(uuid())
  title        String
  ownerId      String
  owner        User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  status       ThreadStatus @default(ACTIVE)
  
  messages     Message[]
  meta         ThreadMeta?
  users        UserThread[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ownerId])
  @@index([updatedAt])
}

enum ThreadStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model Message {
  id           String   @id @default(uuid())
  threadId     String
  thread       Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  role         MessageRole
  content      String   @db.Text
  
  // Optional: Link to a QueryHistory if this message generated an SQL
  queryId      String?
  query        QueryHistory? @relation(fields: [queryId], references: [id])

  timestamp    DateTime @default(now())
  
  @@index([threadId])
  @@index([timestamp])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model ThreadMeta {
  id              String   @id @default(uuid())
  threadId        String   @unique
  thread          Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  contextSummary  String?  @db.Text
  topicTags       String[] @default([])
  importanceScore Float    @default(0)
  
  updatedAt       DateTime @updatedAt
}

model UserThread {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  threadId     String
  thread       Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  isPinned     Boolean  @default(false)
  lastAccess   DateTime @default(now())
  
  @@unique([userId, threadId])
  @@index([userId])
}

// ===========================================
// AI 자동 정책 조정 (Automated Policy Adjustment)
// ===========================================

enum PolicyArea {
  UX
  AI
  PERFORMANCE
  SECURITY
  OPERATION
}

enum ExecutionMethod {
  IMMEDIATE
  PHASED
  AB_TEST
  ROLLBACK_ENABLED
}

model PolicyTrigger {
  id          String   @id @default(uuid())
  name        String   // e.g. "Low Utilization"
  metric      String   // e.g. "utilization_score"
  operator    String   // "LT", "GT"
  threshold   Float    // e.g. 20 (percent)
  windowSeconds Int    // e.g. 604800 (7 days)
  
  description String?
  isActive    Boolean  @default(true)
  
  rules       PolicyAdjustmentRule[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PolicyAdjustmentRule {
  id          String   @id @default(uuid())
  name        String   // e.g. "Stabilization Rule"
  area        PolicyArea
  
  // Matrix Logic
  triggers    PolicyTrigger[]
  
  // Adjustment
  targetParameter String   // e.g. "auto_execute_enabled"
  adjustmentValue Json     // e.g. { "value": false }
  method      ExecutionMethod @default(IMMEDIATE)
  
  isActive    Boolean  @default(true)
  priority    Int      @default(0)

  logs        PolicyAdjustmentLog[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PolicyAdjustmentLog {
  id          String   @id @default(uuid())
  ruleId      String
  rule        PolicyAdjustmentRule @relation(fields: [ruleId], references: [id])
  
  previousValue Json
  newValue      Json
  reason        String
  
  appliedAt   DateTime @default(now())
  revertedAt  DateTime?
}

// ===========================================
// 보안 감사 로그
// ===========================================
enum AuditActionType {
  // DDL 작업
  DDL_CREATE
  DDL_ALTER
  DDL_DROP
  DDL_TRUNCATE
  
  // DML 작업
  DML_INSERT
  DML_UPDATE
  DML_DELETE
  
  // 쿼리 실행
  QUERY_EXECUTE
  
  // 인증
  AUTH_LOGIN
  AUTH_LOGOUT
  AUTH_FAILED
  AUTH_PASSWORD_CHANGE
  AUTH_PASSWORD_RESET
  
  // 권한 관리
  PERMISSION_GRANT
  PERMISSION_REVOKE
  ROLE_CHANGE
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  USER_ACTIVATE
  USER_DEACTIVATE
  
  // 데이터 접근
  SENSITIVE_DATA_ACCESS
  BULK_DATA_ACCESS
  DATA_EXPORT
  DATA_IMPORT
  
  // 시스템 이벤트
  SYSTEM_STARTUP
  SYSTEM_SHUTDOWN
  BACKUP_CREATE
  BACKUP_RESTORE
  
  // API 보안
  API_KEY_CREATE
  API_KEY_REVOKE
  RATE_LIMIT_EXCEEDED
  UNAUTHORIZED_ACCESS
  
  // 세션 관리
  SESSION_TIMEOUT
  SESSION_HIJACK_ATTEMPT
  CONCURRENT_LOGIN
  SESSION_TERMINATED
  
  // 설정 변경
  CONFIG_CHANGE
  DATASOURCE_CREATE
  DATASOURCE_UPDATE
  DATASOURCE_DELETE
  
  // 메타데이터
  METADATA_VIEW
  METADATA_MODIFY
  SCHEMA_SYNC
  
  // 즐겨찾기
  FAVORITE_CREATE
  FAVORITE_DELETE
  
  // AI 관련
  AI_QUERY_GENERATE
  AI_MODEL_CHANGE
  AI_PROMPT_MODIFY
  
  // 파괴적 작업
  DESTRUCTIVE_CONFIRM
  DESTRUCTIVE_REJECT
}

enum AuditSeverity {
  INFO
  WARNING
  DANGER
  CRITICAL
}

enum AuditCategory {
  AUTH          // 인증/권한
  DATA          // 데이터 접근
  ADMIN         // 관리 작업
  SYSTEM        // 시스템 이벤트
  AI            // AI 관련
  QUERY         // 쿼리 실행
  SECURITY      // 보안 이벤트
}

enum AlertStatus {
  OPEN          // 미확인
  ACKNOWLEDGED  // 확인됨
  RESOLVED      // 해결됨
  DISMISSED     // 무시됨
}

model AuditLog {
  id            String          @id @default(uuid())
  
  // 작업 정보
  actionType    AuditActionType
  category      AuditCategory   @default(QUERY)
  severity      AuditSeverity   @default(INFO)
  description   String
  
  // SQL 관련
  sqlQuery      String?         @db.Text
  tableName     String?
  affectedRows  Int?
  
  // 사용자 정보
  userId        String?
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail     String?
  userName      String?
  ipAddress     String?
  userAgent     String?
  
  // 데이터소스
  dataSourceId  String?
  dataSourceName String?
  
  // 실행 결과
  success       Boolean         @default(true)
  errorMessage  String?         @db.Text
  executionTime Int?            // ms
  
  // 세션 및 요청 추적
  sessionId     String?
  session       AuditSession?   @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  requestId     String?         // 분산 트레이싱용
  
  // API 정보
  apiEndpoint   String?
  httpMethod    String?         // GET, POST, PUT, DELETE
  
  // 변경 전/후 값 추적
  previousValue Json?
  newValue      Json?
  
  // 클라이언트 정보
  clientInfo    Json?           // { browser, os, device, version }
  
  // 지리 정보 (IP 기반)
  geoInfo       Json?           // { country, city, region, lat, lon }
  
  // 위험도 점수
  riskScore     Int             @default(0)  // 0-100
  
  // 메타데이터
  metadata      Json?
  
  // 관련 보안 경고
  securityAlerts SecurityAlert[]
  
  createdAt     DateTime        @default(now())
  
  @@index([actionType])
  @@index([category])
  @@index([severity])
  @@index([userId])
  @@index([dataSourceId])
  @@index([createdAt])
  @@index([success])
  @@index([sessionId])
  @@index([riskScore])
  @@index([ipAddress])
}

// ===========================================
// 감사 세션 (사용자 세션별 활동 그룹화)
// ===========================================
model AuditSession {
  id            String    @id @default(uuid())
  
  // 사용자 정보
  userId        String?
  userEmail     String?
  userName      String?
  
  // 세션 정보
  ipAddress     String?
  userAgent     String?
  clientInfo    Json?
  geoInfo       Json?
  
  // 세션 시간
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  lastActivityAt DateTime @default(now())
  
  // 세션 통계
  activityCount Int       @default(0)
  riskScore     Int       @default(0)  // 세션 전체 위험도
  
  // 세션 상태
  isActive      Boolean   @default(true)
  terminatedReason String?
  
  // 관련 로그
  logs          AuditLog[]
  
  @@index([userId])
  @@index([startedAt])
  @@index([isActive])
  @@index([riskScore])
}

// ===========================================
// 보안 경고
// ===========================================
model SecurityAlert {
  id            String      @id @default(uuid())
  
  // 경고 정보
  alertType     String      // BRUTE_FORCE, SUSPICIOUS_ACCESS, DATA_BREACH, etc.
  title         String
  description   String      @db.Text
  severity      AuditSeverity @default(WARNING)
  
  // 상태
  status        AlertStatus @default(OPEN)
  
  // 관련 감사 로그
  auditLogId    String?
  auditLog      AuditLog?   @relation(fields: [auditLogId], references: [id], onDelete: SetNull)
  
  // 관련 사용자
  userId        String?
  userEmail     String?
  ipAddress     String?
  
  // 처리 정보
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?   @db.Text  // 해결 방법/메모
  
  // 메타데이터
  metadata      Json?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([alertType])
  @@index([status])
  @@index([severity])
  @@index([userId])
  @@index([createdAt])
}

// ===========================================
// 추천 질문 관리
// ===========================================
model RecommendedQuestion {
  id           String   @id @default(uuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  
  question     String   @db.Text
  category     String?
  tags         String[] @default([])
  description  String?  @db.Text
  
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  
  // AI 생성 여부
  isAIGenerated Boolean @default(false)
  
  // 생성자 정보
  createdById   String?
  createdByName String?
  source        String   @default("ADMIN") // ADMIN | QUERY_PAGE | SYSTEM
  
  // 사용 통계
  useCount     Int      @default(0)
  lastUsedAt   DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([dataSourceId])
  @@index([isActive])
  @@index([createdById])
  @@index([source])
}
